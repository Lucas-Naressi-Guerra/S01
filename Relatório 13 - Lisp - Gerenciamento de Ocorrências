;; 1. Estrutura da ocorrência
(defstruct ocorrencia
  nome
  ritual
  nivel-medo
  agentes-enviados)

;; 2. Função recursiva: soma total do nível de medo
(defun soma-medo-recursiva (lista)
  (if (endp lista)
      0
      (+ (ocorrencia-nivel-medo (first lista))
         (soma-medo-recursiva (rest lista)))))

;; 3. Função analise-final
(defun analise-final (lista)
  (let ((media (/ (soma-medo-recursiva lista) (length lista))))
    (mapcar #'ocorrencia-nome
            (remove-if-not
             (lambda (o)
               (and (> (ocorrencia-agentes-enviados o) 3)
                    (> (ocorrencia-nivel-medo o) media)))
             lista))))

;; 4. Função para cadastrar uma ocorrência
(defun cadastrar-ocorrencia ()
  (format t "~%Nome da ocorrência: ")
  (let ((nome (read-line)))
    (format t "Ritual envolvido: ")
    (let ((ritual (read-line)))
      (format t "Nível de medo (número): ")
      (let ((medo (read)))
        (format t "Número de agentes enviados: ")
        (let ((agentes (read)))
          (make-ocorrencia :nome nome :ritual ritual :nivel-medo medo :agentes-enviados agentes))))))

;; 5. Função para montar a lista de ocorrências
(defun montar-lista (n)
  (loop repeat n collect (cadastrar-ocorrencia)))

;; 6. Execução principal
(format t "~%Quantas ocorrências deseja cadastrar? ")
(setq n (read))
(setq lista-ocorrencias (montar-lista n))

(format t "~%--- Ocorrências críticas ---~%")
(dolist (nome (analise-final lista-ocorrencias))
  (format t "~A~%" nome))
